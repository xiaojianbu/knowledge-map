# 执行上下文

## 参考来源

[JavaScript 的执行上下文 作者：田小计划](http://www.cnblogs.com/wilber2013/p/4909430.html)

JS 中存在三种代码运行环境：

- Global Code JS 代码开始运行的默认环境
- Function Code 代码进入一个 JS 函数
- Eval Code 使用 eval()执行代码

为了表示不同的运行环境，JS 中有一个执行上下文的改变。当 JS 代码执行的时候，会进入不同的执行上下文，这些执行上下文就构成了一个执行上下文栈。

例如下面的 JS 代码

```js
var a = 'global var'

function foo() {
  console.log(a)
}

function outerFunc() {
  var b = 'var in outerFunc'
  console.log(b)

  function innerFunc() {
    var c = 'var in innerFunc'
    console.log(c)
    foo()
  }

  innerFunc()
}

outerFunc()
```

代码首先进入 Global Execution Context, 然后依次进入 outerFunc, innerFunc 和 foo 的执行上下文，执行上下文栈就可以表示为：

![执行上下文栈](https://raw.githubusercontent.com/xiaojianbu/markdownPicture/master/%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87/%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%871.png)

每个执行上下文都有三个重要的属性，变量对象（Variable object, VO）, 作用域链（Scope chain）和 this。

## 变量对象

变量对象是与执行上下问相关的数据作用域。它是一个与上下文相关的特殊对象，其中存储了在上下文中定义的变量和函数声明。

一般会包含以下信息：

- 变量
- 函数声明
- 函数的形参

当 JS 代码运行时，如果试图寻找一个变量，就会首先查找变量对象。对于上面例子中的代码，Global Execution Context 中变量对象表示如下：

![全局上下文变量对象](https://raw.githubusercontent.com/xiaojianbu/markdownPicture/master/%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87/%E5%85%A8%E5%B1%80%E4%B8%8A%E4%B8%8B%E6%96%87%E5%8F%98%E9%87%8F%E5%AF%B9%E8%B1%A1.png)

**注意** 若上面的例子代码中有下面两个语句，全局上下文变量对象不变

```js
(function bar(){})) // 函数表达式
baz = 'property of global object'
```

对于变量对象有两种特殊情况：

- 函数表达式不包含在变量对象中
- 没有使用 var 声明的变量

## 活动对象

只用全局上下文的变量对象允许通过变量对象的属性名称剪接访问；在函数执行上下文中，变量对象是不能直接访问的，此时由激活对象（Activation Object）扮演变量对象的角色。激活对象是进入函数上下文时刻被创建的，它通过函数的 arguments 属性初始化。

Arguments Objects 是函数上下文里的激活对象中的内部函数，它包括下列属性：

- callee 指向当前函数的引用
- length 真正传递的参数的个数
- properties-indexes: 函数的参数值

## 执行上下问

当一段 JS 代码执行的时候，JS 解释器会创建执行上下文，创建分为两个阶段：

- 创建阶段（当函数被调用，但是开始执行函数内部代码之前）

  - 创建 Scope chain
  - 创建 VO/AO
  - 设置 this 的值

- 激活/代码执行阶段

  - 设置变量的值、函数的引用，然后解释/执行代码

### 创建 VO/AO

- 根据函数的参数，创建并初始化 argument object
- 扫描函数内部代码，查找函数声明

  - 对于所有找到的函数声明，将函数名称和函数引用存入 VO/AO 中
  - 如果 VO/AO 中已经有同名的函数，那么就进行覆盖。

- 扫描函数内部代码，查找变量声明

  - 对于所有找到的变量声明，将变量名存入 VO/AO 中，并初始化为 'undefined'
  - 如果变量名称跟已经声明的形式参数或函数相同，则变量声明不会干扰已经存在的这类属性。
