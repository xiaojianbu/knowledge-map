# 代码

## 目录结构

index.js => 入口文件

services => 接口 API

effects => 副作用的函数（ajax 请求等）

components => 页面布局组件

## index.js 内容框架

```js
// 引入依赖
import React from 'react'
import Layout from './components/Layout'
import Effects from './effects'

export default {
  // 渲染模板
  template: '<div class="component-container"></div>',
  // 状态数据
  state: {
    // 表格数据
    dataSource: [],
    // 查询条件
    query: {}
  },
  // 副作用函数
  effects() {
    return new Effects(this)
  },
  // 渲染函数
  render: () => <Layout />,
  // 初始化方法
  onInit() {
    this.store.dispatch({
      type: 'initData'
    })
  }
}
```

## services 内容框架

```js
import util from 'util'

export default util.createRequest({
  // 查询凭证汇总列表
  getList: 'accountbook/voucherSummary/getList'
})
```

## effects 内容框架

```js
import { BaseEffects } from 'effects'
import services from '../services'

export default class Effects extends BaseEffects {
  // 获取列表数据
  async $getList() {
    const { query } = this.getState()
    const data = await services.getList(query)
    const dataSource = data.list
    const { voucherAffixCount, voucherCount } = data
    this.setState({ dataSource, voucherAffixCount, voucherCount })
  }

  // 保存查询条件并查询
  async queryList() {
    await this.$getList()
  }

  // 保存查询条件并查询
  async saveAndQueryList(query) {
    this.dispatch({
      type: 'updateState',
      payload: {
        query
      }
    })
    await this.$getList()
  }

  // 初始化页面
  async initData() {
    this.initPeriod()
    await this.$getList()
  }
}
```

## 组件代码

- Layout
- MoneyInput

## css modules

```html
import './style.less' import styles from './style2.less'

<!-- 模块化 class -->
<div styleName="class1 class2" className="{styles.test}">test</div>

<!-- 模块化 class + 全局 class -->
<div styleName="class1 class2" className="global-class">test</div>
```

## 发布

```js
  //由于发布是不停机发布，目前所有菜单模块都是按需加载的，如果用户在点击某个菜单前，刚好发布完，那可能点击这个菜单模块的js服务器已经不存在了，所以可能会出现点击菜单报错问题
  //因此文件名不能以name.chunkHash.js形式，改用版本号可以解决这个问题
  output: {
    filename: 'resource/script/[name].js?_=[hash:7]',
    publicPath: '/',
    path: path.resolve(__dirname, './dist'),
  },
```

## ajax 下载文件

```js
// ajax下载文件
api.downloadFile = function(url, filename, data) {
  const xhr = new XMLHttpRequest()
  const formData = new FormData()
  xhr.open('post', url, true)
  xhr.responseType = 'blob'
  xhr.onreadystatechange = function() {
    if (this.status === 200) {
      try {
        const a = document.createElement('a')
        a.href = URL.createObjectURL(this.response)
        a.download = filename
        document.body.appendChild(a)
        a.click()
        a.remove()
      } catch (e) {
        throw e
      }
    }
  }
  for (const i in data) {
    formData.append(i, data[i])
  }
  xhr.send(formData)
}
```

## util

```js
const util = {}
util.store = function(...args) {
  const name = args[0]
  const data = JSON.parse(window.localStorage.getItem(name) || '{}')
  if (args.length > 1) {
    window.localStorage.setItem(name, JSON.stringify(data))
  }
}
util.getLen = function(val) {
  let len = 0
  val = val.split('')
  for (let i = 0; i < val.length; i++) {
    // 全角
    if (val[i].match(/[^x00-xff]/gi) !== null) {
      len += 2
    } else {
      len += 1
    }
  }
  return len
}
```

## animation

```js
const animation =
  window.requestAnimationFrame ||
  window.webkitRequestAnimationFrame ||
  window.mozRequestAnimationFrame ||
  function(cb) {
    window.setTimeout(cb, 1000 / 60)
  }
const cancelAnimation = window.cancelAnimationFrame || window.clearTimeout(id)
```

## 添加菜单

E:\trunk\accounting\src\platform\layout\utils\createMenus.js

E:\trunk\accounting\src\platform\public\router.js

## 1
